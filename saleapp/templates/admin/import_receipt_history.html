{% extends 'admin/base_admin.html' %}
{% block page_title %}Lịch sử phiếu nhập{% endblock %}

{% block content %}
<div class="container-fluid px-5 py-4">
    <div class="content-wrapper">
        <div class="table-responsive">
            <table class="table table-bordered text-center align-middle">
                <thead>
                <tr>
                    <th>STT</th>
                    <th>Mã phiếu</th>
                    <th>Người nhập</th>
                    <th>Ngày nhập</th>
                    <th>Tổng tiền</th>
                    <th>Ghi chú</th>
                    <th>Thao tác</th>
                </tr>
                </thead>
                <tbody>
                {% for r in receipts %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td><code>#{{ r.id }}</code></td>
                    <td>{{ r.user.name }}</td>
                    <td>{{ r.import_date.strftime('%d/%m/%Y %H:%M:%S') }}</td>
                    <td>{{ "{:,.0f}".format(r.total_amount) }} đ</td>
                    <td>{{ r.note or '-' }}</td>
                    <td class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewReceiptDetail({{ r.id }})">
                            <i class="bi bi-eye"></i> Chi tiết
                        </button>
                        <a class="btn btn-sm btn-outline-dark"
                           href="{{ url_for('import_receipts_history.print_import_receipt', receipt_id=r.id) }}"
                           target="_blank">
                            <i class="bi bi-printer"></i> In PDF
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="7">Không có phiếu nhập nào.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal chi tiết phiếu nhập -->
<div class="modal fade" id="receiptDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modalTitle" class="modal-title">Chi tiết phiếu nhập</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="receiptInfo" class="mb-3"></div>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead>
                        <tr>
                            <th>STT</th>
                            <th>Tên sách</th>
                            <th>Giá nhập</th>
                            <th>Số lượng</th>
                            <th>Thành tiền</th>
                        </tr>
                        </thead>
                        <tbody id="receiptItems"></tbody>
                    </table>
                </div>
                <div class="text-end fw-bold mt-3" id="receiptTotal"></div>
            </div>
            <div class="modal-footer">
                <a id="printLink" href="#" target="_blank" class="btn btn-dark">
                    <i class="bi bi-printer"></i> In phiếu
                </a>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script>
    function viewReceiptDetail(id) {
        fetch(`/admin/import_receipts_history/detail/${id}`)
            .then(r => r.json())
            .then(data => {
                const r = data.receipt;

                document.getElementById('modalTitle').innerText = `Phiếu nhập #${r.id}`;
                document.getElementById('receiptInfo').innerHTML = `
                    <div><b>Người nhập:</b> ${r.user_name}</div>
                    <div><b>Ngày nhập:</b> ${r.import_date}</div>
                    <div><b>Ghi chú:</b> ${r.note || '-'}</div>
                `;

                const tbody = document.getElementById('receiptItems');
                tbody.innerHTML = '';
                r.details.forEach((d, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${d.book_name}</td>
                        <td class="text-end">${Number(d.unit_price).toLocaleString()} đ</td>
                        <td class="text-center">${d.quantity}</td>
                        <td class="text-end">${(d.unit_price * d.quantity).toLocaleString()} đ</td>
                    `;
                    tbody.appendChild(tr);
                });

                document.getElementById('receiptTotal').innerText =
                    `Tổng tiền: ${Number(r.total_amount).toLocaleString()} đ`;
                document.getElementById('printLink').href = `/admin/import_receipts_history/receipt/${r.id}/print`;

                const modal = new bootstrap.Modal(document.getElementById('receiptDetailModal'));
                modal.show();
            });
    }
</script>
{% endblock %}
