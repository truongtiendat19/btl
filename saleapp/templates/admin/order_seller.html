{% extends 'admin/base_admin.html' %}
{% block page_title %}
Theo dõi đơn hàng
{% endblock %}

{% block content %}
<div class="container-fluid px-5 py-4">
    <div class="content-wrapper">

        <!-- Bộ lọc -->
        <form method="get" class="row g-2 mb-3">
            <div class="col-md-4">
                <input type="text" name="q" class="form-control" placeholder="Tìm kiếm..." value="{{ q }}">
            </div>
            <div class="col-md-3">
                <select name="status" class="form-select">
                    <option value="">-- Trạng thái --</option>
                    {% for s in ['PENDING','SHIPPING','COMPLETED','CANCELLED'] %}
                    <option value="{{ s }}" {% if status==s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select name="pay" class="form-select">
                    <option value="">-- Thanh toán --</option>
                    {% for p in ['PAID','UNPAID','REFUND'] %}
                    <option value="{{ p }}" {% if pay_status==p %}selected{% endif %}>{{ p }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-grid">
                <button class="btn btn-primary">Lọc</button>
            </div>
        </form>

        <!-- Bảng -->
        <div class="table-responsive">
            <table class="table table-bordered text-center align-middle">
                <thead>
                <tr>
                    <th>STT</th>
                    <th>Mã đơn</th>
                    <th>Khách hàng</th>
                    <th>Ngày đặt</th>
                    <th>Trạng thái</th>
                    <th>Thanh toán</th>
                    <th>Tổng tiền</th>
                    <th>Thao tác</th>
                </tr>
                </thead>
                <tbody>
                {% for o in orders %}
                <tr>
                    <td>{{ (loop.index + (page-1)*12) }}</td>
                    <td><code>{{ o.order_id }}</code></td>
                    <td>{{ o.customer_name }} <small class="text-muted">({{ o.customer_username }})</small></td>
                    <td>{{ o.order_date.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>
                        <select class="form-select form-select-sm" onchange="updateStatus({{ o.id }}, this.value)">
                            {% for s in ['PENDING','SHIPPING','COMPLETED','CANCELLED'] %}
                            <option value="{{ s }}" {% if o.status==s %}selected{% endif %}>{{ s }}</option>
                            {% endfor %}
                        </select>
                    </td>

                    <td>
                        <select class="form-select form-select-sm"
                                onchange="updatePaymentStatus({{ o.id }}, this.value)">
                            {% for p in ['PAID','UNPAID','REFUND'] %}
                            <option value="{{ p }}" {% if o.payment_status==p %}selected{% endif %}>{{ p }}</option>
                            {% endfor %}
                        </select>
                    </td>

                    <td>{{ "{:,.0f}".format(o.total_amount) }} đ</td>
                    <td class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewDetail({{ o.id }})">
                            <i class="bi bi-eye"></i> Chi tiết
                        </button>
                        <a class="btn btn-sm btn-outline-dark" href="{{ url_for('orders_seller.invoice', order_id=o.id) }}" target="_blank">
                            <i class="bi bi-printer"></i> In hoá đơn
                        </a>
                        {% if o.status not in ['CANCELLED','COMPLETED'] %}
                        <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder({{ o.id }})">
                            <i class="bi bi-x-circle"></i> Hủy
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="8">Chưa có đơn hàng.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Phân trang -->
        {% if total_pages > 1 %}
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                {% for p in range(1, total_pages+1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="?q={{ q }}&status={{ status }}&pay={{ pay_status }}&page={{ p }}">{{ p }}</a>
                </li>
                {% endfor %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Modal chi tiết -->
<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modalTitle" class="modal-title">Chi tiết đơn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" ></button>
            </div>
            <div class="modal-body">
                <div id="orderInfo" class="mb-3"></div>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead>
                        <tr>
                            <th>Sách</th>
                            <th>SL</th>
                            <th>Đơn giá</th>
                            <th>Thành tiền</th>
                        </tr>
                        </thead>
                        <tbody id="orderItems"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <a id="invoiceLink" href="#" target="_blank" class="btn btn-dark">
                    <i class="bi bi-printer"></i> In hoá đơn
                </a>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script>
    function viewDetail(id) {
      fetch(`/admin/orders_seller/detail/${id}`)
        .then(r => r.json())
        .then(data => {
          const o = data.order;
          document.getElementById('modalTitle').innerText = `Đơn #${o.order_id}`;
          document.getElementById('orderInfo').innerHTML = `
            <div><b>Khách hàng:</b> ${o.customer_name} (${o.customer_username})</div>
            <div><b>Ngày đặt:</b> ${o.order_date}</div>
            <div><b>Trạng thái:</b> ${o.status} | <b>Thanh toán:</b> ${o.payment_status} (${o.payment_method})</div>
            <div><b>Địa chỉ:</b> ${o.shipping_address}</div>
            <div><b>Tổng tiền:</b> ${Number(o.total_amount).toLocaleString()} đ</div>
          `;
          const tbody = document.getElementById('orderItems');
          tbody.innerHTML = '';
          data.items.forEach(it => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${it.book_name}</td>
              <td class="text-center">${it.quantity}</td>
              <td class="text-end">${Number(it.unit_price).toLocaleString()} đ</td>
              <td class="text-end">${Number(it.line_total).toLocaleString()} đ</td>
            `;
            tbody.appendChild(tr);
          });
          document.getElementById('invoiceLink').href = `/admin/orders_seller/invoice/${o.id}`;
          const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
          modal.show();
        });
    }

    function cancelOrder(id) {
      if (!confirm('Bạn chắc chắn muốn hủy đơn hàng này?')) return;
      const form = new FormData();
      form.append('id', id);
      fetch('/admin/orders_seller/cancel', { method: 'POST', body: form })
        .then(r => r.json())
        .then(res => {
          if (res.ok) {
            location.reload();
          } else {
            alert(res.msg || 'Hủy đơn thất bại');
          }
        }).catch(() => alert('Có lỗi xảy ra.'));
    }
    function updateStatus(orderId, newStatus) {
        if (!confirm(`Đổi trạng thái đơn #${orderId} thành "${newStatus}"?`)) return;

        const form = new FormData();
        form.append('id', orderId);
        form.append('status', newStatus);

        fetch('/admin/orders_seller/update_status', {
            method: 'POST',
            body: form
        })
        .then(r => r.json())
        .then(res => {
            if (res.ok) {
                alert('Cập nhật trạng thái thành công!');
            } else {
                alert(res.msg || 'Cập nhật trạng thái thất bại.');
            }
        })
        .catch(() => alert('Có lỗi xảy ra khi cập nhật.'));
    }

    function updatePaymentStatus(orderId, newPayStatus) {
        if (!confirm(`Đổi trạng thái thanh toán đơn #${orderId} thành "${newPayStatus}"?`)) return;

        const form = new FormData();
        form.append('id', orderId);
        form.append('payment_status', newPayStatus);

        fetch('/admin/orders_seller/update_status', {
            method: 'POST',
            body: form
        })
        .then(r => r.json())
        .then(res => {
            if (res.ok) {
                alert('Cập nhật thanh toán thành công!');
            } else {
                alert(res.msg || 'Cập nhật thanh toán thất bại.');
            }
        })
        .catch(() => alert('Có lỗi xảy ra khi cập nhật.'));
    }
</script>
{% endblock %}
