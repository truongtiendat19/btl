{% extends 'admin/base_admin.html' %}

{% block page_title %}Báo cáo Bán sách{% endblock %}

{% block content %}
<div class="content-wrapper">
    <form method="get" class="container mb-4">
        <div class="row justify-content-center align-items-center g-3 p-3 bg-light rounded shadow-sm">
            <!-- Tháng -->
            <div class="col-auto">
                <label for="month" class="col-form-label fw-semibold">Tháng:</label>
            </div>
            <div class="col-auto">
                <select name="month" id="month" class="form-select">
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Năm -->
            <div class="col-auto">
                <label for="year" class="col-form-label fw-semibold">Năm:</label>
            </div>
            <div class="col-auto">
                <select name="year" id="year" class="form-select">
                    {% for y in range(now.year - 5, now.year + 1) %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Nút -->
            <div class="col-auto">
                <button type="submit" class="btn btn-primary fw-semibold px-4">Xem</button>
            </div>
        </div>
    </form>

    <h2 class="text-center text-primary">Báo Cáo Doanh Thu Tháng {{ month }}/{{ year }}</h2>
    <div class="d-flex mb-3">
        <label class="me-2 fw-semibold">Chế độ hiển thị:</label>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="toggleView">
            <label class="form-check-label" for="toggleView">Biểu đồ</label>
        </div>
    </div>

    <div class="summary mb-4">
        <p><strong>Tổng đơn hàng:</strong> {{ total_orders }}</p>
        <p><strong>Tổng doanh thu:</strong> {{ "{:,.0f}".format(total_revenue) }} VNĐ</p>
    </div>

    <div id="table-view">
        <h5 class="text-center mt-3 mb-3">Bảng Doanh Thu theo Thể loại</h5>
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>STT</th>
                <th>Thể loại</th>
                <th>Doanh thu</th>
            </tr>
            </thead>
            <tbody>
            {% for name, revenue in stats %}
            <tr>
                <td>{{ loop.index }}</td>
                <td class="text-start">{{ name }}</td>
                <td>{{ "{:,.0f}".format(revenue or 0) }} VNĐ</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="3"><em>Không có dữ liệu.</em></td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="chart-view" style="display:none;">
        <h5 class="text-center mt-3">Biểu đồ Doanh Thu theo Thể loại</h5>
        <div style="max-width: 500px; margin-left: 20%;">
            <canvas id="revenuePieChart" height="200"></canvas>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const chartLabels = {{ stats | map(attribute=0) | list | tojson }};
    const chartData = {{ stats | map(attribute=1) | list | tojson }};

    const ctx = document.getElementById('revenuePieChart').getContext('2d');

    const pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: chartLabels,
            datasets: [{
                data: chartData,
                backgroundColor: chartLabels.map((_, i) =>
                    `hsl(${(i * 360 / chartLabels.length) % 360}, 70%, 60%)`
                )
            }]
        },
        options: {
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });

    const toggle = document.getElementById('toggleView');
    const tableView = document.getElementById('table-view');
    const chartView = document.getElementById('chart-view');

    toggle.addEventListener('change', function () {
        if (this.checked) {
            tableView.style.display = 'none';
            chartView.style.display = 'block';
        } else {
            tableView.style.display = 'block';
            chartView.style.display = 'none';
        }
    });
</script>
{% endblock %}
