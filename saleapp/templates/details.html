{% extends 'layout/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- H√¨nh ·∫£nh s√°ch -->
        <div class="col-md-4 col-12 mb-4">
            <img src="{{ book.image or 'https://via.placeholder.com/400x600?text=No+Image' }}"
                 class="img-fluid rounded border shadow-sm w-100" alt="{{ book.name }}">
        </div>

        <!-- Box b√™n ph·∫£i (gi·ªëng Tiki) -->
        <div class="col-md-8 col-12">
            <div class="card shadow-sm p-4">
                <!-- Nh√† b√°n -->
                <div class="d-flex align-items-center mb-3">
                    <img src="{{ book.seller.logo if book.seller and book.seller.logo else 'https://via.placeholder.com/40' }}"
                         alt="Seller Logo" width="40" height="40" class="me-2">
                    <div>
                        <strong>{{ book.seller.name if book.seller else 'Nh√† b√°n kh√¥ng x√°c ƒë·ªãnh' }}</strong><br>
                        <span class="text-warning">‚òÖ {{ book.seller.rating if book.seller and book.seller.rating else '4.8' }}</span>
                        <span class="text-muted">({{ book.seller.review_count if book.seller and book.seller.review_count else '3.6k+' }} ƒë√°nh gi√°)</span>
                    </div>
                </div>

               <!-- Ch·ªçn s·ªë l∆∞·ª£ng -->
                <div class="mb-3">
                    <label class="form-label fw-bold">S·ªë l∆∞·ª£ng</label>
                    <div class="input-group" style="width: 130px;">
                        <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(-1)">-</button>
                        <input type="text" id="quantity" class="form-control text-center" value="1">
                        <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(1)">+</button>
                    </div>
                    <small class="text-muted d-block mt-1">üì¶ C√≤n l·∫°i: {{ book.quantity }} quy·ªÉn</small>
                </div>

                <!-- Gi√° -->
                <h4 class="text-danger fw-bold">
                    {% if book.price_physical > 0 %}
                        {{ "{:,.0f}".format(book.price_physical) }}‚Ç´
                    {% else %}
                        Mi·ªÖn ph√≠
                    {% endif %}
                </h4>

                <!-- H√†nh ƒë·ªông -->
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-danger btn-lg" onclick="buyNow()">Mua ngay</button>
                    <button class="btn btn-outline-primary" onclick="addToCart({{ book.id }}, '{{ book.name }}', {{ book.price_physical }})">Th√™m v√†o gi·ªè</button>
                    <button class="btn btn-outline-secondary">Mua tr∆∞·ªõc tr·∫£ sau</button>
                </div>
            </div>


            <div class="mt-4">
                <button class="btn btn-outline-secondary" onclick="toggleDescription()">üìò Xem m√¥ t·∫£ s√°ch</button>
                <div id="book-description" class="mt-3" style="display: none;">
                    <div class="card card-body">
                        {{ book.description | safe if book.description else 'Kh√¥ng c√≥ m√¥ t·∫£ cho s√°ch n√†y.' }}
                    </div>
                </div>
            </div>

            {% if book.is_digital_avaible %}
              <div class="mt-3">
                {% if current_user.is_authenticated %}
                  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#readModal">ƒê·ªçc s√°ch</button>
                {% else %}
                  <a href="/login?next=/books/{{ book.id }}" class="btn btn-primary">ƒêƒÉng nh·∫≠p ƒë·ªÉ ƒë·ªçc</a>
                {% endif %}
              </div>
            {% endif %}

           <!-- Modal G√≥i ƒë·ªçc s√°ch -->
            <div class="modal fade" id="readModal" tabindex="-1" aria-labelledby="readModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-xl">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="readModalLabel">C√°c g√≥i ƒë·ªçc s√°ch</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                  </div>

                  <div class="modal-body">
                    {% if reading_packages %}
                      <div class="row g-3">
                        {% for pkg in reading_packages %}
                          <div class="col-md-4">
                            <div class="card h-100 shadow-sm border">
                              <div class="card-body d-flex flex-column">
                                <h5 class="card-title text-primary">
                                  {% if pkg.access_type == 'free' %}
                                    Mi·ªÖn ph√≠
                                  {% elif pkg.access_type == 'prenium' %}
                                    Prenium
                                  {% endif %}
                                </h5>
                                <p class="mb-1"><strong>Th·ªùi gian:</strong> {{ pkg.duration_day }} ng√†y</p>

                                {% if pkg.access_type != 'free' %}
                                  <p class="mb-1">
                                    <strong>Gi√°:</strong>
                                    <span class="text-danger">{{ "{:,.0f}".format(pkg.price) }}‚Ç´</span>
                                  </p>
                                {% endif %}

                                <p class="small text-muted">{{ pkg.description }}</p>
                                <div class="mt-auto">
                                  <button class="btn btn-primary" onclick="buyReadingPackage({{ pkg.id }}, '{{ pkg.access_type }}')">
                                      {% if pkg.access_type == 'free' %} ƒê·ªçc {% else %} Mua {% endif %}
                                  </button>

                                </div>
                              </div>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <p>Hi·ªán ch∆∞a c√≥ g√≥i ƒë·ªçc n√†o kh·∫£ d·ª•ng.</p>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>


    <!-- B√¨nh lu·∫≠n -->
    <div class="mt-5">
        <h4>üí¨ B√¨nh lu·∫≠n</h4>

        {% if current_user.is_authenticated %}
        <div class="mb-3">
            <textarea class="form-control" id="comment" rows="4" placeholder="Vi·∫øt b√¨nh lu·∫≠n..."></textarea>
            <button class="btn btn-info mt-2" onclick="addComment({{ book.id }})">üì© G·ª≠i b√¨nh lu·∫≠n</button>
        </div>
        {% else %}
            <p class="text-muted">Vui l√≤ng <a href="/login?next=/books/{{ book.id }}">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ b√¨nh lu·∫≠n.</p>
        {% endif %}

        <ul class="list-group mt-3" id="comments">
            {% for c in comments %}
            <li class="list-group-item">
                <div class="d-flex align-items-start">
                    <img src="{{ c.user.avatar or 'https://via.placeholder.com/50' }}"
                         class="rounded-circle me-3" width="50" height="50" alt="avatar">
                    <div>
                        <p class="mb-1">{{ c.content }}</p>
                        <small class="text-muted date">{{ c.created_date }}</small>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- JavaScript -->
<script>
    window.onload = function () {
        let dates = document.getElementsByClassName("date");
        for (let d of dates)
            d.innerText = moment(d.innerText).locale("vi").fromNow();
    }

    function updateQuantity(change) {
        const quantityInput = document.getElementById('quantity');
        let current = parseInt(quantityInput.value);
        current = isNaN(current) ? 1 : current;
        current += change;
        if (current < 1) current = 1;
        quantityInput.value = current;
    }

    function buyNow() {
        const quantity = parseInt(document.getElementById('quantity').value);
        alert(`Mua ngay v·ªõi s·ªë l∆∞·ª£ng: ${quantity}`);
        // B·∫°n c√≥ th·ªÉ thay th·∫ø b·∫±ng chuy·ªÉn ƒë·∫øn /checkout v·ªõi quantity
    }

    function addToCart(id, name, price_physical) {
        const quantity = parseInt(document.getElementById('quantity').value);
        fetch('/api/carts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, name: name, price_physical: price_physical, quantity: quantity })
        })
        .then(res => res.json())
        .then(data => {
            alert('ƒê√£ th√™m v√†o gi·ªè h√†ng!');
            if (document.querySelector('.cart-quantity')) {
                document.querySelector('.cart-quantity').textContent = data.total_quantity;
            }
        })
        .catch(err => console.error('L·ªói th√™m gi·ªè h√†ng:', err));
    }

    function addComment(bookId) {
        let content = document.getElementById("comment").value;
        fetch(`/api/books/${bookId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content })
        })
        .then(res => res.json())
        .then(data => {
            location.reload();
        })
        .catch(err => console.error(err));
    }

    function toggleDescription() {
        const desc = document.getElementById("book-description");
        desc.style.display = (desc.style.display === "none") ? "block" : "none";
    }

   const bookId = {{ book.id | tojson }};

function buyReadingPackage(packageId, accessType) {
  if (accessType === 'free') {
    fetch('/api/buy_reading_package', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        package_id: packageId,
        book_id: bookId
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        window.location.href = `/read/${bookId}`;
      } else {
        alert(data.message || 'B·∫°n ƒë√£ d√πng g√≥i ƒë·ªçc mi·ªÖn ph√≠!');
      }
    })
    .catch(err => {
      console.error('L·ªói:', err);
      alert('C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω g√≥i ƒë·ªçc!');
    });
  } else {
    window.location.href = `/checkout_reading_package?package_id=${packageId}&book_id=${bookId}`;
  }
}

</script>
{% endblock %}
