{% extends 'layout/base.html' %}

{% block content %}
<div class="container px-3 px-md-5 mt-4">
  <div class="row g-4">
    <!-- C·ªôt tr√°i: Th·ªÉ lo·∫°i ph·ªï bi·∫øn (sticky) -->
    <div class="col-md-2 col-ad">
      <div class="ad-banner sticky-top" style="top: 20px;">
        <h5 class="text-center mb-3">·ªäTh·ªÉ lo·∫°i ph·ªï bi·∫øn</h5>
        <ul class="list-group">
          {% for category in categories %}
            <a href="{{ url_for('index', category_id=category.id) }}" class="list-group-item list-group-item-action">
              {{ category.name }}
            </a>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- C·ªôt ch√≠nh -->
    <div class="col-md-8">
      <!-- H√†ng ch·ª©a h√¨nh ·∫£nh v√† th√¥ng tin -->
      <div class="row g-4">
        <div class="col-md-4">
          <img src="{{ book.image or 'https://via.placeholder.com/400x600?text=No+Image' }}" class="img-fluid rounded border w-100 book-image">
        </div>

        <div class="col-md-8">
          <div class="card p-4 shadow-sm">
            <div class="d-flex align-items-center mb-3">
              <img src="{{ book.seller.logo if book.seller and book.seller.logo else 'https://via.placeholder.com/40' }}" alt="Seller Logo" class="me-2 rounded" width="40" height="40">
              <div>
                <strong>{{ book.seller.name if book.seller else 'Nh√† b√°n kh√¥ng x√°c ƒë·ªãnh' }}</strong><br>
                <span class="text-warning">‚òÖ {{ book.seller.rating if book.seller and book.seller.rating else '4.8' }}</span>
                <small class="text-muted">({{ book.seller.review_count if book.seller and book.seller.review_count else '3.6k+' }} ƒë√°nh gi√°)</small>
              </div>
            </div>

            <h3 class="fw-bold">{{ book.name }}</h3>
            <p class="text-muted small">T√°c gi·∫£: {{ book.author.name if book.author else 'Kh√¥ng r√µ' }} | C√≤n: {{ book.quantity }} quy·ªÉn</p>

            <div class="mb-3">
              <div class="text-warning fs-5">
                {% set rounded_rating = (avg_rating or 0)|int %}
                {% for i in range(rounded_rating) %}‚òÖ{% endfor %}
                {% for i in range(5 - rounded_rating) %}‚òÜ{% endfor %}
                <span class="text-dark">({{ total_reviews }} ƒë√°nh gi√°)</span>
              </div>
            </div>

            <div class="row align-items-center g-3">
              <div class="col-auto">
                <label class="form-label">S·ªë l∆∞·ª£ng</label>
                <div class="input-group" style="width: 120px;">
                  <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(-1)">-</button>
                  <input type="text" id="quantity" class="form-control text-center" value="1">
                  <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(1)">+</button>
                </div>
              </div>

              <div class="col">
                <h4 class="text-danger fw-bold">
                  {% if book.price_physical > 0 %}
                    {{ "{:,.0f}".format(book.price_physical) }}‚Ç´
                  {% else %}Mi·ªÖn ph√≠{% endif %}
                </h4>
              </div>

              <div class="col text-end">
                <button class="btn btn-danger" onclick="addToCart({{ book.id }}, '{{ book.name }}', {{ book.price_physical }})">
                  ‚ù§Ô∏è Th√™m v√†o gi·ªè
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gi·ªõi thi·ªáu -->
      <div class="mt-4">
        <button class="btn btn-outline-secondary" onclick="toggleDescription()">üìò Xem m√¥ t·∫£ s√°ch</button>
        <div id="book-description" class="mt-3" style="display: none;">
          <div class="card card-body">
            {{ book.description | safe if book.description else 'Kh√¥ng c√≥ m√¥ t·∫£ cho s√°ch n√†y.' }}
          </div>
        </div>
      </div>

      <!-- S√°ch li√™n quan -->
      {% if related_books %}
      <div class="related-books mt-4">
        <h2 class="section-title">S√°ch li√™n quan</h2>
        <div class="related-books-list">
          {% for related_book in related_books %}
            <a href="{{ url_for('details', book_id=related_book.id) }}" class="related-book-item text-decoration-none text-dark">
              <img src="{{ related_book.image or 'https://via.placeholder.com/150?text=No+Image' }}" alt="{{ related_book.name }}" class="related-book-image">
              <p class="related-book-name">{{ related_book.name }}</p>
              <p class="related-book-price">
                {% if related_book.price_physical > 0 %}
                  {{ "{:,.0f}".format(related_book.price_physical) }}‚Ç´
                {% else %}Mi·ªÖn ph√≠{% endif %}
              </p>
            </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Th√¥ng tin chi ti·∫øt -->
      <div class="card card-body mt-4">
        <h5 class="fw-bold">Th√¥ng tin chi ti·∫øt</h5>
        <div class="row">
          <div class="col-md-6">
            <p><strong>C√¥ng ty ph√°t h√†nh:</strong> {{ book.publisher_company or '...ƒêang c·∫≠p nh·∫≠t' }}</p>
            <p><strong>Ng√†y xu·∫•t b·∫£n:</strong> {{ book.publish_date or '...ƒêang c·∫≠p nh·∫≠t' }}</p>
            <p><strong>Lo·∫°i b√¨a:</strong> {{ book.cover_type or '...ƒêang c·∫≠p nh·∫≠t' }}</p>
          </div>
          <div class="col-md-6">
            <p><strong>S·ªë trang:</strong> {{ book.page_count or '...ƒêang c·∫≠p nh·∫≠t' }}</p>
            <p><strong>Nh√† xu·∫•t b·∫£n:</strong> {{ book.publisher_name or '...ƒêang c·∫≠p nh·∫≠t' }}</p>
          </div>
        </div>
      </div>

    </div>

    <!-- C·ªôt ph·∫£i: Khuy·∫øn m√£i (sticky) -->
    <div class="col-md-2 col-ad">
      <div class="ad-banner sticky-top" style="top: 20px;">
        <h5 class="text-center mb-3">Khuy·∫øn m√£i ƒë·∫∑c bi·ªát</h5>
        <div class="card mb-3 promotion-card">
          <img src="https://via.placeholder.com/150x200?text=Khuy·∫øn+M√£i" class="card-img-top" alt="Khuy·∫øn m√£i">
          <div class="card-body">
            <h6 class="card-title">Gi·∫£m 20% t·∫•t c·∫£ s√°ch</h6>
            <p class="card-text">ƒê·∫øn 10/08/2025</p>
          </div>
        </div>
        <div class="card promotion-card">
          <img src="https://via.placeholder.com/150x200?text=M·ªõi+Nh·∫•t" class="card-img-top" alt="S√°ch m·ªõi">
          <div class="card-body">
            <h6 class="card-title">S√°ch m·ªõi ra m·∫Øt</h6>
            <p class="card-text">Kh√°m ph√° ngay!</p>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
<!-- ƒê√°nh gi√° & B√¨nh lu·∫≠n -->
<div class="card card-body mt-4">
  <h5 class="fw-bold mb-3">üí¨ ƒê√°nh gi√° & B√¨nh lu·∫≠n</h5>
  {% if current_user.is_authenticated %}
    {% set purchase = purchases_dict.values() | selectattr('book_id', 'equalto', book.id) | selectattr('status', 'equalto', 'COMPLETED') | first %}
    {% if purchase %}
      <div class="mb-3">
        <label for="stars" class="form-label">Ch·ªçn sao</label>
        <select class="form-select w-auto mb-2" id="stars">
          <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ - Tuy·ªát v·ªùi</option>
          <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ - T·ªët</option>
          <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ - Trung b√¨nh</option>
          <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ - T·ªá</option>
          <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ - R·∫•t t·ªá</option>
        </select>
        <textarea id="comment_content" name="content" class="form-control mb-2" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..."></textarea>
        <button class="btn btn-primary" onclick="submitComment({{ book.id }})">üì© G·ª≠i b√¨nh lu·∫≠n</button>
      </div>
    {% else %}
      <p class="text-muted">Vui l√≤ng mua s√°ch ƒë·ªÉ c√≥ th·ªÉ b√¨nh lu·∫≠n. <a href="/books/{{ book.id }}">Mua ngay</a></p>
    {% endif %}
  {% else %}
    <p class="text-muted">Vui l√≤ng <a href="/login?next=/books/{{ book.id }}">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ b√¨nh lu·∫≠n.</p>
  {% endif %}

  <ul class="list-group mt-3" id="comments">
    {% for c in comments %}
    <li class="list-group-item">
      <div class="d-flex align-items-start">
        <img src="{{ c.user.avatar or 'https://via.placeholder.com/50' }}" class="rounded-circle me-3" width="50" height="50">
        <div>
          <strong>{{ c.user.name }}</strong>
          <div class="text-warning small mb-1">
            {% for i in range(c.rating or 5) %}‚òÖ{% endfor %}
            {% for i in range(5 - (c.rating or 5)) %}‚òÜ{% endfor %}
          </div>
          {% if c.verified %}<span class="badge bg-success">ƒê√£ mua h√†ng</span>{% endif %}
          <p class="mb-1">{{ c.comment }}</p>
          <small class="text-muted date">{{ c.created_date }}</small>
        </div>
      </div>
    </li>
    {% endfor %}
  </ul>
</div>
<script>
  function updateQuantity(change) {
    const quantityInput = document.getElementById('quantity');
    let current = parseInt(quantityInput.value);
    current = isNaN(current) ? 1 : current + change;
    if (current < 1) current = 1;
    quantityInput.value = current;
  }

  function addToCart(id, name, price) {
    const quantity = parseInt(document.getElementById('quantity').value);
    fetch('/api/carts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, name, price, quantity })
    })
    .then(res => res.json())
    .then(data => alert('ƒê√£ th√™m v√†o gi·ªè h√†ng!'))
    .catch(err => console.error(err));
  }

  function submitComment(bookId) {
  const content = document.getElementById('comment_content').value;
  const stars = document.getElementById('stars').value;

  fetch(`/api/books/${bookId}/comments`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ content, stars })
})
.then(async response => {
  const data = await response.json();
  if (response.ok) {
    alert('B√¨nh lu·∫≠n ƒë√£ ƒë∆∞·ª£c g·ª≠i!');
    location.reload();
  } else {
    alert(data.error || 'L·ªói khi g·ª≠i b√¨nh lu·∫≠n.');
  }
})
.catch(error => {
  alert('L·ªói h·ªá th·ªëng, vui l√≤ng th·ª≠ l·∫°i.');
  console.error('Error:', error);
});

}

  function showToast(message, isError = false) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white ${isError ? 'bg-danger' : 'bg-success'} border-0 show`;
    toast.role = 'alert';
    toast.style.position = 'fixed';
    toast.style.bottom = '1rem';
    toast.style.right = '1rem';
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
      </div>`;
    document.body.appendChild(toast);

    setTimeout(() => toast.remove(), 3000);
  }
</script>
{% endblock %}