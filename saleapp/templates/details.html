{% extends 'layout/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- H√¨nh ·∫£nh s√°ch -->
        <div class="col-md-5 col-12 mb-3">
            <img src="{{ book.image or 'https://via.placeholder.com/400x600?text=No+Image' }}"
                 class="img-fluid rounded border shadow-sm w-100" alt="{{ book.name }}">
        </div>

        <!-- Th√¥ng tin chi ti·∫øt s√°ch -->
        <div class="col-md-7 col-12">
            <h2 class="fw-bold">{{ book.name }}</h2>
            <p class="text-muted">T√°c gi·∫£: <strong>{{ book.author.name if book.author else 'Kh√¥ng r√µ' }}</strong></p>
            <p class="text-muted">Th·ªÉ lo·∫°i: <strong>{{ book.category.name if book.category else 'Kh√¥ng r√µ' }}</strong></p>

            <h4 class="text-danger mt-3">
                {% if book.price_physical > 0 %}
                    {{ "{:,.0f}".format(book.price_physical) }} VNƒê
                {% else %}
                    Mi·ªÖn ph√≠
                {% endif %}
            </h4>

            <div class="mt-3">
                <button class="btn btn-danger btn-lg" onclick="addToCart({{ book.id }}, '{{ book.name }}', {{ book.price_physical }})">
                    üõí ƒê·∫∑t h√†ng
                </button>
            </div>
        </div>
    </div>

    <!-- B√¨nh lu·∫≠n -->
    <div class="mt-5">
        <h4>üí¨ B√¨nh lu·∫≠n</h4>

        {% if current_user.is_authenticated %}
        <div class="mb-3">
            <textarea class="form-control" id="comment" rows="4" placeholder="Vi·∫øt b√¨nh lu·∫≠n..."></textarea>
            <button class="btn btn-info mt-2" onclick="addComment({{ book.id }})">üì© G·ª≠i b√¨nh lu·∫≠n</button>
        </div>
        {% else %}
            <p class="text-muted">Vui l√≤ng <a href="/login?next=/books/{{ book.id }}">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ b√¨nh lu·∫≠n.</p>
        {% endif %}

        <ul class="list-group mt-3" id="comments">
            {% for c in comments %}
            <li class="list-group-item">
                <div class="d-flex align-items-start">
                    <img src="{{ c.user.avatar or 'https://via.placeholder.com/50' }}" class="rounded-circle me-3" width="50" height="50">
                    <div>
                        <p class="mb-1">{{ c.content }}</p>
                        <small class="text-muted date">{{ c.created_date }}</small>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
    window.onload = function() {
        let dates = document.getElementsByClassName("date");
        for (let d of dates)
            d.innerText = moment(d.innerText).locale("vi").fromNow();
    }

    function addToCart(id, name, price_physical) {
    fetch('/api/carts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: id, name: name, price_physical: price_physical })
    })
    .then(res => res.json())
    .then(data => {
        alert('ƒê√£ th√™m v√†o gi·ªè h√†ng!');
        if (document.querySelector('.cart-quantity')) {
            document.querySelector('.cart-quantity').textContent = data.total_quantity;
        }
    })
    .catch(err => console.error('L·ªói th√™m gi·ªè h√†ng:', err));

    function addComment(bookId) {
        let content = document.getElementById("comment").value;
        fetch(`/api/books/${bookId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content })
        })
        .then(res => res.json())
        .then(data => {
            location.reload();
        })
        .catch(err => console.error(err));
    }
</script>
{% endblock %}
