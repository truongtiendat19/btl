{% extends 'layout/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Hình ảnh sách -->
        <div class="col-md-4 col-12 mb-4">
            <img src="{{ book.image or 'https://via.placeholder.com/400x600?text=No+Image' }}"
                 class="img-fluid rounded border shadow-sm w-100" alt="{{ book.name }}">
        </div>

        <!-- Box bên phải (giống Tiki) -->
        <div class="col-md-8 col-12">
            <div class="card shadow-sm p-4">
                <!-- Nhà bán -->
                <div class="d-flex align-items-center mb-3">
                    <img src="{{ book.seller.logo if book.seller and book.seller.logo else 'https://via.placeholder.com/40' }}"
                         alt="Seller Logo" width="40" height="40" class="me-2">
                    <div>
                        <strong>{{ book.seller.name if book.seller else 'Nhà bán không xác định' }}</strong><br>
                        <span class="text-warning">★ {{ book.seller.rating if book.seller and book.seller.rating else '4.8' }}</span>
                        <span class="text-muted">({{ book.seller.review_count if book.seller and book.seller.review_count else '3.6k+' }} đánh giá)</span>
                    </div>
                </div>

               <!-- Chọn số lượng -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Số lượng</label>
                    <div class="input-group" style="width: 130px;">
                        <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(-1)">-</button>
                        <input type="text" id="quantity" class="form-control text-center" value="1">
                        <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(1)">+</button>
                    </div>
                    <small class="text-muted d-block mt-1">📦 Còn lại: {{ book.quantity }} quyển</small>
                </div>


                <!-- Giá -->
                <h4 class="text-danger fw-bold">
                    {% if book.price_physical > 0 %}
                        {{ "{:,.0f}".format(book.price_physical) }}₫
                    {% else %}
                        Miễn phí
                    {% endif %}
                </h4>

                <!-- Hành động -->
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-outline-primary" onclick="addToCart({{ book.id }}, '{{ book.name }}', {{ book.price_physical }})">Thêm vào giỏ</button>

                </div>
            </div>

            <!-- Mô tả sách -->
<div class="mt-4">
    <h5 class="fw-bold mb-3">📘 Mô tả sách</h5>
    <div class="card card-body">
        {{ book.description | safe if book.description else 'Không có mô tả cho sách này.' }}
    </div>
</div>

{% if book.is_digital_avaible %}
    <div class="mt-3">
        {% if current_user.is_authenticated %}
            {% if has_access or book.is_free_reading %}
                <a href="{{ url_for('read_book', book_id=book.id) }}" class="btn btn-success btn-lg">
                    📖 Đọc sách
                </a>
            {% else %}
                <a href="{{ url_for('buy_book_access', book_id=book.id) }}" class="btn btn-outline-primary btn-lg">
                    💳 Mua quyền đọc
                </a>
            {% endif %}
        {% else %}
            <a href="/login?next=/books/{{ book.id }}" class="btn btn-outline-secondary btn-lg">
                🔐 Đăng nhập để đọc
            </a>
        {% endif %}
    </div>
{% endif %}


    <!-- Bình luận -->
    <div class="mt-5">
        <h4>💬 Bình luận</h4>

        {% if current_user.is_authenticated %}
        <div class="mb-3">
            <textarea class="form-control" id="comment" rows="4" placeholder="Viết bình luận..."></textarea>
            <button class="btn btn-info mt-2" onclick="addComment({{ book.id }})">📩 Gửi bình luận</button>
        </div>
        {% else %}
            <p class="text-muted">Vui lòng <a href="/login?next=/books/{{ book.id }}">đăng nhập</a> để bình luận.</p>
        {% endif %}

        <ul class="list-group mt-3" id="comments">
            {% for c in comments %}
            <li class="list-group-item">
                <div class="d-flex align-items-start">
                    <img src="{{ c.user.avatar or 'https://via.placeholder.com/50' }}"
                         class="rounded-circle me-3" width="50" height="50" alt="avatar">
                    <div>
                        <p class="mb-1">{{ c.content }}</p>
                        <small class="text-muted date">{{ c.created_date }}</small>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- JavaScript -->
<script>
    window.onload = function () {
        let dates = document.getElementsByClassName("date");
        for (let d of dates)
            d.innerText = moment(d.innerText).locale("vi").fromNow();
    }

    function updateQuantity(change) {
        const quantityInput = document.getElementById('quantity');
        let current = parseInt(quantityInput.value);
        current = isNaN(current) ? 1 : current;
        current += change;
        if (current < 1) current = 1;
        quantityInput.value = current;
    }

    function buyNow() {
        const quantity = parseInt(document.getElementById('quantity').value);
        alert(`Mua ngay với số lượng: ${quantity}`);
        // Bạn có thể thay thế bằng chuyển đến /checkout với quantity
    }

    function addToCart(id, name, price_physical) {
        const quantity = parseInt(document.getElementById('quantity').value);
        fetch('/api/carts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, name: name, price_physical: price_physical, quantity: quantity })
        })
        .then(res => res.json())
        .then(data => {
            alert('Đã thêm vào giỏ hàng!');
            if (document.querySelector('.cart-quantity')) {
                document.querySelector('.cart-quantity').textContent = data.total_quantity;
            }
        })
        .catch(err => console.error('Lỗi thêm giỏ hàng:', err));
    }

    function addComment(bookId) {
        let content = document.getElementById("comment").value;
        fetch(`/api/books/${bookId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content })
        })
        .then(res => res.json())
        .then(data => {
            location.reload();
        })
        .catch(err => console.error(err));
    }

    function toggleDescription() {
        const desc = document.getElementById("book-description");
        desc.style.display = (desc.style.display === "none") ? "block" : "none";
    }
</script>
{% endblock %}
