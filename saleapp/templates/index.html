{% extends 'layout/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <aside class="col-lg-2 mb-4">
            <div class="bg-white border rounded shadow-sm p-2 fixed-sidebar">
                <h6 class="text-dark d-flex justify-content-between align-items-center">Thể loại
                    <button class="btn btn-sm btn-link p-0 toggle-btn" data-bs-toggle="collapse"
                            data-bs-target="#categoryCollapse"
                            aria-expanded="true" aria-controls="categoryCollapse">
                        <i class="bi bi-caret-down-fill icon-down"></i>
                        <i class="bi bi-caret-up-fill icon-up d-none"></i>

                    </button>
                </h6>
                <div id="categoryCollapse" class="collapse show">
                    <ul class="list-unstyled mb-3">
                        <li><a href="{{ url_for('index') }}"
                               class="text-decoration-none {% if not request.args.get('category_id') %}fw-bold text-primary{% endif %}">
                            Tất cả
                        </a></li>
                        {% for category in categories %}
                        <li>
                            <a href="{{ url_for('index', category_id=category.id) }}"
                               class="text-decoration-none {% if request.args.get('category_id')|string == category.id|string %}fw-bold text-primary{% endif %}">
                                {{ category.name }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <h6 class="text-dark d-flex justify-content-between align-items-center">Tác giả
                    <button class="btn btn-sm btn-link p-0 toggle-btn"
                            data-bs-toggle="collapse"
                            data-bs-target="#authorCollapse"
                            aria-expanded="true" aria-controls="authorCollapse">
                        <i class="bi bi-caret-down-fill icon-down"></i>
                        <i class="bi bi-caret-up-fill icon-up d-none"></i>
                    </button>
                </h6>
                <div id="authorCollapse" class="collapse show">
                    <ul class="list-unstyled mb-3">
                        <li><a href="{{ url_for('index') }}"
                               class="text-decoration-none {% if not request.args.get('author_id') %}fw-bold text-primary{% endif %}">
                            Tất cả
                        </a></li>
                        {% for author in authors %}
                        <li>
                            <a href="{{ url_for('index', author_id=author.id) }}"
                               class="text-decoration-none {% if request.args.get('author_id')|string == author.id|string %}fw-bold text-primary{% endif %}">
                                {{ author.name }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>


                <h6 class="text-dark d-flex justify-content-between align-items-center">Giá
                    <button class="btn btn-sm btn-link p-0 toggle-btn" data-bs-toggle="collapse"
                            data-bs-target="#priceCollapse"
                            aria-expanded="true" aria-controls="priceCollapse">
                        <i class="bi bi-caret-down-fill icon-down"></i>
                        <i class="bi bi-caret-up-fill icon-up d-none"></i>
                    </button>
                </h6>
                <div id="priceCollapse" class="collapse show">
                    <ul class="list-unstyled">
                        <li><a href="{{ url_for('index') }}"
                               class="text-decoration-none {% if not request.args.get('price_filter') %}fw-bold text-primary{% endif %}">Tất cả</a></li>

                        <li><a href="{{ url_for('index', price_filter='0-100000') }}"
                               class="text-decoration-none {% if request.args.get('price_filter') == '0 – 100,000' %}fw-bold text-primary{% endif %}">0 – 100,000</a></li>

                        <li><a href="{{ url_for('index', price_filter='100000-200000') }}"
                               class="text-decoration-none {% if request.args.get('price_filter') == '100,000 – 200,000' %}fw-bold text-primary{% endif %}">100,000 – 200,000</a></li>

                        <li><a href="{{ url_for('index', price_filter='200000-500000') }}"
                               class="text-decoration-none {% if request.args.get('price_filter') == '200,000 – 500,000' %}fw-bold text-primary{% endif %}">200,000 – 500,000</a></li>

                        <li><a href="{{ url_for('index', price_filter='500000+') }}"
                               class="text-decoration-none {% if request.args.get('price_filter') == '500,000 +' %}fw-bold text-primary{% endif %}">500,000 +</a></li>
                    </ul>
                </div>


            </div>
        </aside>

        <section class="col-lg-10">
            <!-- Carousel -->
            <div id="bookCarousel" class="carousel slide mb-4 shadow rounded" data-bs-ride="carousel">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="https://thietkelogo.edu.vn/uploads/images/thiet-ke-do-hoa-khac/banner-sach/11.png"
                             class="d-block w-100" alt="Banner 1">
                    </div>
                    <div class="carousel-item">
                        <img src="https://thietkelogo.edu.vn/uploads/images/thiet-ke-do-hoa-khac/banner-sach/2.png"
                             class="d-block w-100" alt="Banner 2">
                    </div>
                    <div class="carousel-item">
                        <img src="https://thietkelogo.edu.vn/uploads/images/thiet-ke-do-hoa-khac/banner-sach/10.png"
                             class="d-block w-100" alt="Banner 3">
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#bookCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                    <span class="visually-hidden">Trước</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#bookCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon"></span>
                    <span class="visually-hidden">Sau</span>
                </button>
            </div>

            <!-- Danh sách sách -->
            <h4 class="section-title">Sách hay, hấp dẫn</h4>
            {% if books %}
            <div class="row custom-card-row">
                {% for book in books %}
                <div class="col-md-3">
                    <div class="card h-100 shadow-sm border-0 position-relative rounded">
                        {% if book.is_digital_avaible %}
                        <span class="badge-custom">Đọc Online</span>
                        {% endif %}

                        <img src="{{ book.image or 'https://via.placeholder.com/300x400?text=No+Image' }}"
                             class="card-img-top rounded-top" alt="{{ book.name }}">

                        <div class="card-body d-flex flex-column text-start">
                            <small> {{ book.author.name or 'Đang cập nhật'}}</small>
                            <h6 class="card-title">{{ book.name }}</h6>
                            <p class="card-price">
                                {% if book.price_physical > 0 %}
                                {{ "{:,.0f}".format(book.price_physical) }} ₫
                                {% endif %}
                            </p>
                            {%if book.is_active == False or book.quantity < 1%}
                            <i>Đã hết hàng</i>
                            {% endif %}
                            <a href="{{ url_for('details', book_id=book.id) }}" class="stretched-link"></a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Phân trang -->
            {% if pages > 1 %}
            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    {% for p in range(1, pages + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('index', page=p) }}">{{ p }}</a>
                    </li>
                    {% endfor %}
                </ul>
            </nav>
            {% endif %}
            {% else %}
            <div class="alert alert-warning">Không tìm thấy sách nào phù hợp.</div>
            {% endif %}
        </section>
    </div>
</div>
<!-- ==== Chatbot HTML ==== -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/chatbot.css') }}">

<!-- Chatbot Toggler -->
<button id="chatbot-toggler">
    <span class="material-symbols-rounded">mode_comment</span>
    <span class="material-symbols-rounded">close</span>
</button>

<div class="chatbot-popup">
    <!-- Chatbot Header -->
    <div class="chat-header">
        <div class="header-info">
            <svg class="chatbot-logo" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 1024 1024">
                <path d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5zM867.2 644.5V453.1h26.5c19.4 0 35.1 15.7 35.1 35.1v121.1c0 19.4-15.7 35.1-35.1 35.1h-26.5zM95.2 609.4V488.2c0-19.4 15.7-35.1 35.1-35.1h26.5v191.3h-26.5c-19.4 0-35.1-15.7-35.1-35.1zM561.5 149.6c0 23.4-15.6 43.3-36.9 49.7v44.9h-30v-44.9c-21.4-6.5-36.9-26.3-36.9-49.7 0-28.6 23.3-51.9 51.9-51.9s51.9 23.3 51.9 51.9z"/>
            </svg>
            <h2 class="logo-text">Chatbot</h2>
        </div>
        <button id="close-chatbot" class="material-symbols-rounded">keyboard_arrow_down</button>
    </div>

    <!-- Chatbot Body -->
    <div class="chat-body">
        <div class="message bot-message">
            <svg class="bot-avatar" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 1024 1024">
                <path d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5zM867.2 644.5V453.1h26.5c19.4 0 35.1 15.7 35.1 35.1v121.1c0 19.4-15.7 35.1-35.1 35.1h-26.5zM95.2 609.4V488.2c0-19.4 15.7-35.1 35.1-35.1h26.5v191.3h-26.5c-19.4 0-35.1-15.7-35.1-35.1zM561.5 149.6c0 23.4-15.6 43.3-36.9 49.7v44.9h-30v-44.9c-21.4-6.5-36.9-26.3-36.9-49.7 0-28.6 23.3-51.9 51.9-51.9s51.9 23.3 51.9 51.9z"/>
            </svg>
            <div class="message-text">Xin chào 👋<br /> Tôi có thể giúp gì cho bạn hôm nay?</div>
        </div>
    </div>

    <!-- Chatbot Footer -->
    <div class="chat-footer">
        <form action="#" class="chat-form">
            <textarea placeholder="Message..." class="message-input" required></textarea>
            <div class="chat-controls">
                <button type="button" id="emoji-picker" class="material-symbols-outlined">sentiment_satisfied</button>
                <div class="file-upload-wrapper">
                    <input type="file" id="file-input" hidden />
                    <img src="#" />
                    <button type="button" id="file-upload" class="material-symbols-rounded">attach_file</button>
                    <button type="button" id="file-cancel" class="material-symbols-rounded">close</button>
                </div>
                <button type="submit" id="send-message" class="material-symbols-rounded">arrow_upward</button>
            </div>
        </form>
    </div>
</div>

<!-- Scripts -->
<script src="chatbot.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.17.2/dist/sweetalert2.all.min.js"></script>
<script src="{{ url_for('static', filename='js/chatbot.js') }}"></script>
<style>
    #bookCarousel {
        height: 260px;
    }

    #bookCarousel .carousel-inner,
    #bookCarousel .carousel-inner img {
        height: 100%;
        object-fit: cover;
    }

    @media (max-width: 991.98px) {
        .fixed-sidebar {
            position: static !important;
        }
    }

    .fixed-sidebar {
        position: sticky;
        top: 20px;
    }

    .fixed-sidebar h6 {
        font-size: 0.9rem;
        font-weight: 600;
        margin: 0;
        padding: 6px 4px 8px 8px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
    }

    .toggle-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 4px;
        transition: background-color 0.2s ease;
    }

    .toggle-btn:hover {
        background-color: #e0e0e0;
    }

    .toggle-btn i {
        font-size: 1rem;
        transition: transform 0.3s ease;
        color: #000;
    }

    .toggle-btn.rotate i {
        transform: rotate(180deg);
    }

    .fixed-sidebar ul {
        padding-left: 0;
        list-style: none;
        margin: 0;
    }

    .fixed-sidebar ul li a {
        display: block;
        padding: 6px 4px 6px 20px;
        font-size: 0.8rem;
        color: #000 !important;
        text-decoration: none;
    }

    .fixed-sidebar ul li a:hover {
        background-color: #f1f1f1;
    }

    .fixed-sidebar ul li a.fw-bold {
        font-weight: bold !important;
        color: #000 !important;
    }

    .sub-menu {
        display: none;
        border-bottom: 1px solid #eee;
    }

    .sub-menu.active {
        display: block;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.toggle-btn').forEach(button => {
            const targetSelector = button.getAttribute('data-bs-target');
            const target = document.querySelector(targetSelector);
            const iconDown = button.querySelector('.icon-down');
            const iconUp = button.querySelector('.icon-up');

            // Nếu đang mở sẵn thì hiển thị icon-up
            if (target.classList.contains('show')) {
                iconDown.classList.add('d-none');
                iconUp.classList.remove('d-none');
            }

            // Sự kiện mở
            target.addEventListener('show.bs.collapse', () => {
                iconDown.classList.add('d-none');
                iconUp.classList.remove('d-none');
            });

            // Sự kiện đóng
            target.addEventListener('hide.bs.collapse', () => {
                iconDown.classList.remove('d-none');
                iconUp.classList.add('d-none');
            });
        });
    });
    function addToCart(id, name, price_physical) {
        fetch('/api/carts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, name, price_physical })
        })
        .then(res => res.json())
        .then(data => {
            alert('📦 Đã thêm vào giỏ hàng!');
            document.querySelector('.cart-quantity').textContent = data.total_quantity;
        })
        .catch(err => console.error('Lỗi:', err));
    }
</script>
{% endblock %}
