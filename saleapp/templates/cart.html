{% extends 'layout/base.html' %}

{% block content %}
<h2>GIỎ HÀNG</h2>

{% if 'cart' in session %}
<div class="cart-container">
    <table class="cart-table">
        <thead>
            <tr>
                <th>Id</th>
                <th>Tên sách</th>
                <th>Loại</th>
                <th>Giá gốc</th>
                <th>Giảm giá</th>
                <th>Giá sau giảm</th>
                <th>Số lượng</th>
                <th>Thành tiền</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody>
            {% for c in cart_stats.cart.values() %}
            <tr>
                <td>{{ c.id }}</td>
                <td>{{ c.name }}</td>
                <td>{{ c.type | capitalize }}</td>
                <td>{{ "{:,.0f}".format(c.price) }} VNĐ</td>
                <td>
                    {% if c.discount_value > 0 %}
                        {% if c.discount_type == 'percentage' %}
                            {{ "{:,.0f}".format(c.discount_value) }} VNĐ
                            ({{ c.discount_value / c.price * 100 | int }}%)
                        {% else %}
                            {{ "{:,.0f}".format(c.discount_value) }} VNĐ
                        {% endif %}
                    {% else %}
                        Không có giảm giá
                    {% endif %}
                </td>
                <td>{{ "{:,.0f}".format(c.final_price) }} VNĐ</td>
                <td>
                    <button class="update-cart" data-book-id="{{ c.id }}" data-delta="-1">−</button>
                    <span class="quantity">{{ c.quantity }}</span>
                    <button class="update-cart" data-book-id="{{ c.id }}" data-delta="1">+</button>
                </td>
                <td>{{ "{:,.0f}".format(c.final_price * c.quantity) }} VNĐ</td>
                <td>
                    <button class="delete-cart" data-book-id="{{ c.id }}">Xóa</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="cart-summary">
        <p><strong>Tổng tiền:</strong> {{ "{:,.0f}".format(cart_stats.total_amount) }} VNĐ</p>
        <p><strong>Tổng số lượng:</strong> {{ cart_stats.total_quantity }}</p>

        {% if current_user.is_authenticated %}
            <a href="{{ url_for('pay') }}" class="checkout-btn">Thanh toán</a>
        {% else %}
    <p>Vui lòng <a href="/login?next=/cart">đăng nhập</a> để thanh toán!</p>
    {% endif %}
    </div>
</div>
{% else %}
    <p>KHÔNG có sách nào trong giỏ hàng!</p>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Cập nhật số lượng
    document.querySelectorAll('.update-cart').forEach(button => {
        button.addEventListener('click', () => {
            const bookId = button.getAttribute('data-book-id');
            const delta = parseInt(button.getAttribute('data-delta'));

            fetch('/api/update-cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ book_id: bookId, delta: delta })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.message || 'Có lỗi xảy ra!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi cập nhật giỏ hàng!');
            });
        });
    });

    // Xóa sản phẩm
    document.querySelectorAll('.delete-cart').forEach(button => {
        button.addEventListener('click', () => {
            const bookId = button.getAttribute('data-book-id');

            fetch(`/api/carts/${bookId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                window.location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi xóa sản phẩm!');
            });
        });
    });
});
</script>
{% endblock %}
